from Bio import Entrez
import time

# Set your email (required by NCBI)
Entrez.email = "anonymous@anonymous.com"

# Define the search term and output
search_term = "Pseudomonas aeruginosa"
retmax = 50000
output_file = "pseudomonas_aeruginosa_50000.fasta"

def fetch_ids():
    print(f"🔍 Searching NCBI for: {search_term}")
    handle = Entrez.esearch(db="nucleotide", term=search_term, retmax=retmax)
    record = Entrez.read(handle)
    handle.close()
    return record["IdList"]

def download_fasta(id_list, output_file):
    with open(output_file, "w") as out_handle:
        for start in range(0, len(id_list), 500):  # NCBI batch size limit
            end = min(start + 500, len(id_list))
            batch_ids = id_list[start:end]
            print(f"⬇️ Downloading batch {start+1}-{end} of {len(id_list)}...")
            try:
                handle = Entrez.efetch(db="nucleotide", id=batch_ids, rettype="fasta", retmode="text")
                data = handle.read()
                handle.close()
                out_handle.write(data)
                time.sleep(1)  # respectful pause
            except Exception as e:
                print(f"⚠️ Error in batch {start+1}-{end}: {e}")
                time.sleep(5)

if __name__ == "__main__":
    ids = fetch_ids()
    print(f"🔢 Total sequences found: {len(ids)}")
    if ids:
        download_fasta(ids, output_file)
        print(f"✅ Download complete: {output_file}")
    else:
        print("❌ No sequences found.")
